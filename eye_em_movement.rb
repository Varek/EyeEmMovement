# -*- encoding : utf-8 -*-
require 'sinatra'
require "sinatra/reloader" if development?
#require 'sinatra/config_file'
require 'EyeEmConnector'
require 'date'
require 'active_support/all'

EyeEmConnector.configure do |config|
  config.client_id = ENV['EYEEM_CLIENT_ID']
end

get '/' do
  erb :home
end

get '/load_movement/:lat/:lng/:start_date' do
  lat = params[:lat].to_f
  lng = params[:lng].to_f
  #return {
  #  1345831200=>[
  #    {"id"=>"869484", "thumbUrl"=>"http://www.eyeem.com/thumb/h/100/0f95aa82792d381d7d9881f21e01ed5fecaa3f2f-1345832903", "photoUrl"=>"http://www.eyeem.com/thumb/640/480/0f95aa82792d381d7d9881f21e01ed5fecaa3f2f-1345832903", "width"=>1296, "height"=>972, "updated"=>"2012-08-24T20:28:24+0200", "webUrl"=>"http://www.eyeem.com/p/869484", "user"=>{"id"=>"3346", "nickname"=>"Analoger", "fullname"=>"io Analoger", "webUrl"=>"http://www.eyeem.com/u/Analoger", "thumbUrl"=>"http://www.eyeem.com/thumb/sq/50/e7f8c7734513ff21c250543f2cb1a7c2cffd22da.jpg", "photoUrl"=>"http://www.eyeem.com/thumb/sq/200/e7f8c7734513ff21c250543f2cb1a7c2cffd22da.jpg"}, "title"=>"", "caption"=>"EyeEm Underground", "latitude"=>"52.52515030", "longitude"=>"13.36928844", "totalLikes"=>18, "totalComments"=>0}, {"id"=>"869482", "thumbUrl"=>"http://www.eyeem.com/thumb/h/100/3898d4107c6d852128ae9a6c0984daefa961a74a-1345832821", "photoUrl"=>"http://www.eyeem.com/thumb/640/480/3898d4107c6d852128ae9a6c0984daefa961a74a-1345832821", "width"=>1296, "height"=>972, "updated"=>"2012-08-24T20:27:03+0200", "webUrl"=>"http://www.eyeem.com/p/869482", "user"=>{"id"=>"3346", "nickname"=>"Analoger", "fullname"=>"io Analoger", "webUrl"=>"http://www.eyeem.com/u/Analoger", "thumbUrl"=>"http://www.eyeem.com/thumb/sq/50/e7f8c7734513ff21c250543f2cb1a7c2cffd22da.jpg", "photoUrl"=>"http://www.eyeem.com/thumb/sq/200/e7f8c7734513ff21c250543f2cb1a7c2cffd22da.jpg"}, "title"=>"", "caption"=>"EyeEm Underground", "latitude"=>"52.52515030", "longitude"=>"13.36928844", "totalLikes"=>22, "totalComments"=>0}, {"id"=>"869473", "thumbUrl"=>"http://www.eyeem.com/thumb/h/100/f3cc0ee1cb4ea24069db2fa060559a20ad1d8416-1345832707", "photoUrl"=>"http://www.eyeem.com/thumb/640/480/f3cc0ee1cb4ea24069db2fa060559a20ad1d8416-1345832707", "width"=>816, "height"=>612, "updated"=>"2012-08-24T20:25:11+0200", "webUrl"=>"http://www.eyeem.com/p/869473", "user"=>{"id"=>"5491", "nickname"=>"severin", "fullname"=>"Severin", "webUrl"=>"http://www.eyeem.com/u/severin", "thumbUrl"=>"http://www.eyeem.com/thumb/sq/50/b9c94f9b2aaa2e0445816f21593035cdc997f53e.jpg", "photoUrl"=>"http://www.eyeem.com/thumb/sq/200/b9c94f9b2aaa2e0445816f21593035cdc997f53e.jpg"}, "title"=>"", "caption"=>"EyeEm Underground at Berlin Hauptbahnhof", "latitude"=>"52.51826096", "longitude"=>"13.37492180", "totalLikes"=>27, "totalComments"=>0}, {"id"=>"869472", "thumbUrl"=>"http://www.eyeem.com/thumb/h/100/1e66b1852be46ec2f5e5bc8f5e7adc407924d9c3-1345832699", "photoUrl"=>"http://www.eyeem.com/thumb/640/480/1e66b1852be46ec2f5e5bc8f5e7adc407924d9c3-1345832699", "width"=>1296, "height"=>972, "updated"=>"2012-08-24T20:25:00+0200", "webUrl"=>"http://www.eyeem.com/p/869472", "user"=>{"id"=>"3346", "nickname"=>"Analoger", "fullname"=>"io Analoger", "webUrl"=>"http://www.eyeem.com/u/Analoger", "thumbUrl"=>"http://www.eyeem.com/thumb/sq/50/e7f8c7734513ff21c250543f2cb1a7c2cffd22da.jpg", "photoUrl"=>"http://www.eyeem.com/thumb/sq/200/e7f8c7734513ff21c250543f2cb1a7c2cffd22da.jpg"}, "title"=>"", "caption"=>"EyeEm Underground at Berlin Hauptbahnhof", "latitude"=>"52.52515030", "longitude"=>"13.36928844", "totalLikes"=>30, "totalComments"=>0}, {"id"=>"869469", "thumbUrl"=>"http://www.eyeem.com/thumb/h/100/f4b47ada9886ef0f8ffd3894a4cee2aa595ed7e8-1345832664", "photoUrl"=>"http://www.eyeem.com/thumb/640/480/f4b47ada9886ef0f8ffd3894a4cee2aa595ed7e8-1345832664", "width"=>816, "height"=>612, "updated"=>"2012-08-24T20:24:25+0200", "webUrl"=>"http://www.eyeem.com/p/869469", "user"=>{"id"=>"5491", "nickname"=>"severin", "fullname"=>"Severin", "webUrl"=>"http://www.eyeem.com/u/severin", "thumbUrl"=>"http://www.eyeem.com/thumb/sq/50/b9c94f9b2aaa2e0445816f21593035cdc997f53e.jpg", "photoUrl"=>"http://www.eyeem.com/thumb/sq/200/b9c94f9b2aaa2e0445816f21593035cdc997f53e.jpg"}, "title"=>"", "caption"=>"EyeEm Underground at Berlin Hauptbahnhof", "latitude"=>"52.51826096", "longitude"=>"13.37492180", "totalLikes"=>18, "totalComments"=>0}, {"id"=>"869465", "thumbUrl"=>"http://www.eyeem.com/thumb/h/100/63ca11b227411d34742af33842d2ec9e1c00c889-1345832597", "photoUrl"=>"http://www.eyeem.com/thumb/640/480/63ca11b227411d34742af33842d2ec9e1c00c889-1345832597", "width"=>1296, "height"=>972, "updated"=>"2012-08-24T20:23:19+0200", "webUrl"=>"http://www.eyeem.com/p/869465", "user"=>{"id"=>"3346", "nickname"=>"Analoger", "fullname"=>"io Analoger", "webUrl"=>"http://www.eyeem.com/u/Analoger", "thumbUrl"=>"http://www.eyeem.com/thumb/sq/50/e7f8c7734513ff21c250543f2cb1a7c2cffd22da.jpg", "photoUrl"=>"http://www.eyeem.com/thumb/sq/200/e7f8c7734513ff21c250543f2cb1a7c2cffd22da.jpg"}, "title"=>"", "caption"=>"EyeEm Underground", "latitude"=>"52.52515030", "longitude"=>"13.36928844", "totalLikes"=>17, "totalComments"=>0}, {"id"=>"869461", "thumbUrl"=>"http://www.eyeem.com/thumb/h/100/0b85d0023f6f1e8c18f9f2a2c63367c89c7e997e-1345832532", "photoUrl"=>"http://www.eyeem.com/thumb/640/480/0b85d0023f6f1e8c18f9f2a2c63367c89c7e997e-1345832532", "width"=>1065, "height"=>1296, "updated"=>"2012-08-24T20:22:16+0200", "webUrl"=>"http://www.eyeem.com/p/869461", "user"=>{"id"=>"16816", "nickname"=>"rosemarierosenroth", "fullname"=>"rosemarie rosenroth", "webUrl"=>"http://www.eyeem.com/u/rosemarierosenroth", "thumbUrl"=>"http://www.eyeem.com/thumb/sq/50/2954fb98ec7f86a5b635493930e8dede2df49110.jpg", "photoUrl"=>"http://www.eyeem.com/thumb/sq/200/2954fb98ec7f86a5b635493930e8dede2df49110.jpg"}, "title"=>"", "caption"=>"EyeEm Underground at Berlin Hauptbahnhof", "latitude"=>"52.52515030", "longitude"=>"13.36928844", "totalLikes"=>22, "totalComments"=>3}, {"id"=>"869457", "thumbUrl"=>"http://www.eyeem.com/thumb/h/100/801d3d5fde4777af74f143c535db1ce9a3123433-1345832449", "photoUrl"=>"http://www.eyeem.com/thumb/640/480/801d3d5fde4777af74f143c535db1ce9a3123433-1345832449", "width"=>442, "height"=>442, "updated"=>"2012-08-24T20:21:47+0200", "webUrl"=>"http://www.eyeem.com/p/869457", "user"=>{"id"=>"59550", "nickname"=>"varek", "fullname"=>"André", "webUrl"=>"http://www.eyeem.com/u/varek", "thumbUrl"=>"https://graph.facebook.com/1449441885/picture?type=square", "photoUrl"=>"https://graph.facebook.com/1449441885/picture?type=large"}, "title"=>"", "caption"=>"EyeEm Underground at Berlin Hauptbahnhof", "latitude"=>"52.52515030", "longitude"=>"13.36928844", "totalLikes"=>11, "totalComments"=>0}, {"id"=>"869451", "thumbUrl"=>"http://www.eyeem.com/thumb/h/100/ff3f7f201a71f3da0e87f71fc5ab96db215ca7c2-1345832336", "photoUrl"=>"http://www.eyeem.com/thumb/640/480/ff3f7f201a71f3da0e87f71fc5ab96db215ca7c2-1345832336", "width"=>589, "height"=>331, "updated"=>"2012-08-24T20:19:57+0200", "webUrl"=>"http://www.eyeem.com/p/869451", "user"=>{"id"=>"59550", "nickname"=>"varek", "fullname"=>"André", "webUrl"=>"http://www.eyeem.com/u/varek", "thumbUrl"=>"https://graph.facebook.com/1449441885/picture?type=square", "photoUrl"=>"https://graph.facebook.com/1449441885/picture?type=large"}, "title"=>"", "caption"=>"EyeEm Underground at Berlin Hauptbahnhof", "latitude"=>"52.52515030", "longitude"=>"13.36928844", "totalLikes"=>9, "totalComments"=>0}, {"id"=>"869449", "thumbUrl"=>"http://www.eyeem.com/thumb/h/100/8afe1277473358be2da02e7d3fd0a271775f82bb-1345832380", "photoUrl"=>"http://www.eyeem.com/thumb/640/480/8afe1277473358be2da02e7d3fd0a271775f82bb-1345832380", "width"=>1296, "height"=>972, "updated"=>"2012-08-24T20:19:42+0200", "webUrl"=>"http://www.eyeem.com/p/869449", "user"=>{"id"=>"3346", "nickname"=>"Analoger", "fullname"=>"io Analoger", "webUrl"=>"http://www.eyeem.com/u/Analoger", "thumbUrl"=>"http://www.eyeem.com/thumb/sq/50/e7f8c7734513ff21c250543f2cb1a7c2cffd22da.jpg", "photoUrl"=>"http://www.eyeem.com/thumb/sq/200/e7f8c7734513ff21c250543f2cb1a7c2cffd22da.jpg"}, "title"=>"", "caption"=>"EyeEm Underground at Berlin Hauptbahnhof", "latitude"=>"52.52515030", "longitude"=>"13.36928844", "totalLikes"=>12, "totalComments"=>0}, {"id"=>"869447", "thumbUrl"=>"http://www.eyeem.com/thumb/h/100/0c30970bddc0dd5f2270a3fe9a6e0abaa922e24c-1345832351", "photoUrl"=>"http://www.eyeem.com/thumb/640/480/0c30970bddc0dd5f2270a3fe9a6e0abaa922e24c-1345832351", "width"=>1296, "height"=>972, "updated"=>"2012-08-24T20:19:13+0200", "webUrl"=>"http://www.eyeem.com/p/869447", "user"=>{"id"=>"3346", "nickname"=>"Analoger", "fullname"=>"io Analoger", "webUrl"=>"http://www.eyeem.com/u/Analoger", "thumbUrl"=>"http://www.eyeem.com/thumb/sq/50/e7f8c7734513ff21c250543f2cb1a7c2cffd22da.jpg", "photoUrl"=>"http://www.eyeem.com/thumb/sq/200/e7f8c7734513ff21c250543f2cb1a7c2cffd22da.jpg"}, "title"=>"", "caption"=>"EyeEm Underground at Berlin Hauptbahnhof", "latitude"=>"52.52515030", "longitude"=>"13.36928844", "totalLikes"=>22, "totalComments"=>1}, {"id"=>"869442", "thumbUrl"=>"http://www.eyeem.com/thumb/h/100/abb20397c60523fb9bd35d7a62475688bbe32fd2-1345832216", "photoUrl"=>"http://www.eyeem.com/thumb/640/480/abb20397c60523fb9bd35d7a62475688bbe32fd2-1345832216", "width"=>1296, "height"=>972, "updated"=>"2012-08-24T20:17:00+0200", "webUrl"=>"http://www.eyeem.com/p/869442", "user"=>{"id"=>"3346", "nickname"=>"Analoger", "fullname"=>"io Analoger", "webUrl"=>"http://www.eyeem.com/u/Analoger", "thumbUrl"=>"http://www.eyeem.com/thumb/sq/50/e7f8c7734513ff21c250543f2cb1a7c2cffd22da.jpg", "photoUrl"=>"http://www.eyeem.com/thumb/sq/200/e7f8c7734513ff21c250543f2cb1a7c2cffd22da.jpg"}, "title"=>"", "caption"=>"EyeEm Underground at Berlin Hauptbahnhof", "latitude"=>"52.52515030", "longitude"=>"13.36928844", "totalLikes"=>25, "totalComments"=>1}, {"id"=>"869432", "thumbUrl"=>"http://www.eyeem.com/thumb/h/100/f26a19c3e5a7b93ee6fd7a69376a2e18f7e4b347-1345831928", "photoUrl"=>"http://www.eyeem.com/thumb/640/480/f26a19c3e5a7b93ee6fd7a69376a2e18f7e4b347-1345831928", "width"=>972, "height"=>1296, "updated"=>"2012-08-24T20:12:17+0200", "webUrl"=>"http://www.eyeem.com/p/869432", "user"=>{"id"=>"16816", "nickname"=>"rosemarierosenroth", "fullname"=>"rosemarie rosenroth", "webUrl"=>"http://www.eyeem.com/u/rosemarierosenroth", "thumbUrl"=>"http://www.eyeem.com/thumb/sq/50/2954fb98ec7f86a5b635493930e8dede2df49110.jpg", "photoUrl"=>"http://www.eyeem.com/thumb/sq/200/2954fb98ec7f86a5b635493930e8dede2df49110.jpg"}, "title"=>"", "caption"=>"EyeEm Underground at Bundeskanzleramt", "latitude"=>"52.52014923", "longitude"=>"13.37012482", "totalLikes"=>21, "totalComments"=>0}, {"id"=>"869398", "thumbUrl"=>"http://www.eyeem.com/thumb/h/100/9c2fcd5370c9378a2ba5cdeaa763a947b5226d85-1345831176", "photoUrl"=>"http://www.eyeem.com/thumb/640/480/9c2fcd5370c9378a2ba5cdeaa763a947b5226d85-1345831176", "width"=>1296, "height"=>972, "updated"=>"2012-08-24T19:59:38+0200", "webUrl"=>"http://www.eyeem.com/p/869398", "user"=>{"id"=>"1014", "nickname"=>"Flo", "fullname"=>"Flo Meissner", "webUrl"=>"http://www.eyeem.com/u/Flo", "thumbUrl"=>"https://graph.facebook.com/603396880/picture?type=square", "photoUrl"=>"https://graph.facebook.com/603396880/picture?type=large"}, "title"=>"", "caption"=>"EyeEm Underground at Deutscher Bundestag", "latitude"=>"52.51859283", "longitude"=>"13.37383842", "totalLikes"=>69, "totalComments"=>6}, {"id"=>"869381", "thumbUrl"=>"http://www.eyeem.com/thumb/h/100/fa3a5834456eed8623e9db69a15409f320e511d1-1345830824", "photoUrl"=>"http://www.eyeem.com/thumb/640/480/fa3a5834456eed8623e9db69a15409f320e511d1-1345830824", "width"=>1296, "height"=>802, "updated"=>"2012-08-24T19:53:47+0200", "webUrl"=>"http://www.eyeem.com/p/869381", "user"=>{"id"=>"106877", "nickname"=>"brainyartist", "fullname"=>"brainyartist", "webUrl"=>"http://www.eyeem.com/u/brainyartist", "thumbUrl"=>"https://graph.facebook.com/100002043068990/picture?type=square", "photoUrl"=>"https://graph.facebook.com/100002043068990/picture?type=large"}, "title"=>"", "caption"=>"EyeEm Underground at Deutscher Bundestag", "latitude"=>"52.51859283", "longitude"=>"13.37383842", "totalLikes"=>12, "totalComments"=>0}, {"id"=>"869372", "thumbUrl"=>"http://www.eyeem.com/thumb/h/100/ebd82ea9e09a9f11f2aedf2bc442c204cdca94a8-1345830472", "photoUrl"=>"http://www.eyeem.com/thumb/640/480/ebd82ea9e09a9f11f2aedf2bc442c204cdca94a8-1345830472", "width"=>972, "height"=>1296, "updated"=>"2012-08-24T19:48:34+0200", "webUrl"=>"http://www.eyeem.com/p/869372", "user"=>{"id"=>"1014", "nickname"=>"Flo", "fullname"=>"Flo Meissner", "webUrl"=>"http://www.eyeem.com/u/Flo", "thumbUrl"=>"https://graph.facebook.com/603396880/picture?type=square", "photoUrl"=>"https://graph.facebook.com/603396880/picture?type=large"}, "title"=>"", "caption"=>"EyeEm Underground at Deutscher Bundestag", "latitude"=>"52.51859283", "longitude"=>"13.37383842", "totalLikes"=>43, "totalComments"=>0}, {"id"=>"869398", "thumbUrl"=>"http://www.eyeem.com/thumb/h/100/9c2fcd5370c9378a2ba5cdeaa763a947b5226d85-1345831176", "photoUrl"=>"http://www.eyeem.com/thumb/640/480/9c2fcd5370c9378a2ba5cdeaa763a947b5226d85-1345831176", "width"=>1296, "height"=>972, "updated"=>"2012-08-24T19:59:38+0200", "webUrl"=>"http://www.eyeem.com/p/869398", "user"=>{"id"=>"1014", "nickname"=>"Flo", "fullname"=>"Flo Meissner", "webUrl"=>"http://www.eyeem.com/u/Flo", "thumbUrl"=>"https://graph.facebook.com/603396880/picture?type=square", "photoUrl"=>"https://graph.facebook.com/603396880/picture?type=large"}, "title"=>"", "caption"=>"EyeEm Underground at Deutscher Bundestag", "latitude"=>"52.51859283", "longitude"=>"13.37383842", "totalLikes"=>69, "totalComments"=>6}], 1345831800=>[], 1345832400=>[{"id"=>"869469", "thumbUrl"=>"http://www.eyeem.com/thumb/h/100/f4b47ada9886ef0f8ffd3894a4cee2aa595ed7e8-1345832664", "photoUrl"=>"http://www.eyeem.com/thumb/640/480/f4b47ada9886ef0f8ffd3894a4cee2aa595ed7e8-1345832664", "width"=>816, "height"=>612, "updated"=>"2012-08-24T20:24:25+0200", "webUrl"=>"http://www.eyeem.com/p/869469", "user"=>{"id"=>"5491", "nickname"=>"severin", "fullname"=>"Severin", "webUrl"=>"http://www.eyeem.com/u/severin", "thumbUrl"=>"http://www.eyeem.com/thumb/sq/50/b9c94f9b2aaa2e0445816f21593035cdc997f53e.jpg", "photoUrl"=>"http://www.eyeem.com/thumb/sq/200/b9c94f9b2aaa2e0445816f21593035cdc997f53e.jpg"}, "title"=>"", "caption"=>"EyeEm Underground at Berlin Hauptbahnhof", "latitude"=>"52.51826096", "longitude"=>"13.37492180", "totalLikes"=>18, "totalComments"=>0}, {"id"=>"869464", "thumbUrl"=>"http://www.eyeem.com/thumb/h/100/57b9411a0ef4f87c8213d7006b73f0a9c475952f-1345832588", "photoUrl"=>"http://www.eyeem.com/thumb/640/480/57b9411a0ef4f87c8213d7006b73f0a9c475952f-1345832588", "width"=>612, "height"=>816, "updated"=>"2012-08-24T20:23:13+0200", "webUrl"=>"http://www.eyeem.com/p/869464", "user"=>{"id"=>"5491", "nickname"=>"severin", "fullname"=>"Severin", "webUrl"=>"http://www.eyeem.com/u/severin", "thumbUrl"=>"http://www.eyeem.com/thumb/sq/50/b9c94f9b2aaa2e0445816f21593035cdc997f53e.jpg", "photoUrl"=>"http://www.eyeem.com/thumb/sq/200/b9c94f9b2aaa2e0445816f21593035cdc997f53e.jpg"}, "title"=>"", "caption"=>"self portrait in Berlin", "latitude"=>"52.30350494", "longitude"=>"13.00804234", "totalLikes"=>49, "totalComments"=>3}, {"id"=>"869459", "thumbUrl"=>"http://www.eyeem.com/thumb/h/100/f702db17ca5f157ebd6a006bad3e31b019f3eebd-1345832531", "photoUrl"=>"http://www.eyeem.com/thumb/640/480/f702db17ca5f157ebd6a006bad3e31b019f3eebd-1345832531", "width"=>816, "height"=>612, "updated"=>"2012-08-24T20:22:13+0200", "webUrl"=>"http://www.eyeem.com/p/869459", "user"=>{"id"=>"5491", "nickname"=>"severin", "fullname"=>"Severin", "webUrl"=>"http://www.eyeem.com/u/severin", "thumbUrl"=>"http://www.eyeem.com/thumb/sq/50/b9c94f9b2aaa2e0445816f21593035cdc997f53e.jpg", "photoUrl"=>"http://www.eyeem.com/thumb/sq/200/b9c94f9b2aaa2e0445816f21593035cdc997f53e.jpg"}, "title"=>"", "caption"=>"EyeEm Underground in Berlin", "latitude"=>"52.30350494", "longitude"=>"13.00804234", "totalLikes"=>25, "totalComments"=>0}, {"id"=>"869455", "thumbUrl"=>"http://www.eyeem.com/thumb/h/100/e32fba8a21e5a44af40af1d0e36b5a3d6ac34a2c-1345832472", "photoUrl"=>"http://www.eyeem.com/thumb/640/480/e32fba8a21e5a44af40af1d0e36b5a3d6ac34a2c-1345832472", "width"=>816, "height"=>612, "updated"=>"2012-08-24T20:21:24+0200", "webUrl"=>"http://www.eyeem.com/p/869455", "user"=>{"id"=>"5491", "nickname"=>"severin", "fullname"=>"Severin", "webUrl"=>"http://www.eyeem.com/u/severin", "thumbUrl"=>"http://www.eyeem.com/thumb/sq/50/b9c94f9b2aaa2e0445816f21593035cdc997f53e.jpg", "photoUrl"=>"http://www.eyeem.com/thumb/sq/200/b9c94f9b2aaa2e0445816f21593035cdc997f53e.jpg"}, "title"=>"", "caption"=>"EyeEm Underground at Berlin Hauptbahnhof", "latitude"=>"52.30350876", "longitude"=>"13.00804615", "totalLikes"=>23, "totalComments"=>0}, {"id"=>"869457", "thumbUrl"=>"http://www.eyeem.com/thumb/h/100/801d3d5fde4777af74f143c535db1ce9a3123433-1345832449", "photoUrl"=>"http://www.eyeem.com/thumb/640/480/801d3d5fde4777af74f143c535db1ce9a3123433-1345832449", "width"=>442, "height"=>442, "updated"=>"2012-08-24T20:21:47+0200", "webUrl"=>"http://www.eyeem.com/p/869457", "user"=>{"id"=>"59550", "nickname"=>"varek", "fullname"=>"André", "webUrl"=>"http://www.eyeem.com/u/varek", "thumbUrl"=>"https://graph.facebook.com/1449441885/picture?type=square", "photoUrl"=>"https://graph.facebook.com/1449441885/picture?type=large"}, "title"=>"", "caption"=>"EyeEm Underground at Berlin Hauptbahnhof", "latitude"=>"52.52515030", "longitude"=>"13.36928844", "totalLikes"=>11, "totalComments"=>0}, {"id"=>"869451", "thumbUrl"=>"http://www.eyeem.com/thumb/h/100/ff3f7f201a71f3da0e87f71fc5ab96db215ca7c2-1345832336", "photoUrl"=>"http://www.eyeem.com/thumb/640/480/ff3f7f201a71f3da0e87f71fc5ab96db215ca7c2-1345832336", "width"=>589, "height"=>331, "updated"=>"2012-08-24T20:19:57+0200", "webUrl"=>"http://www.eyeem.com/p/869451", "user"=>{"id"=>"59550", "nickname"=>"varek", "fullname"=>"André", "webUrl"=>"http://www.eyeem.com/u/varek", "thumbUrl"=>"https://graph.facebook.com/1449441885/picture?type=square", "photoUrl"=>"https://graph.facebook.com/1449441885/picture?type=large"}, "title"=>"", "caption"=>"EyeEm Underground at Berlin Hauptbahnhof", "latitude"=>"52.52515030", "longitude"=>"13.36928844", "totalLikes"=>9, "totalComments"=>0}], 1345833000=>[{"id"=>"869473", "thumbUrl"=>"http://www.eyeem.com/thumb/h/100/f3cc0ee1cb4ea24069db2fa060559a20ad1d8416-1345832707", "photoUrl"=>"http://www.eyeem.com/thumb/640/480/f3cc0ee1cb4ea24069db2fa060559a20ad1d8416-1345832707", "width"=>816, "height"=>612, "updated"=>"2012-08-24T20:25:11+0200", "webUrl"=>"http://www.eyeem.com/p/869473", "user"=>{"id"=>"5491", "nickname"=>"severin", "fullname"=>"Severin", "webUrl"=>"http://www.eyeem.com/u/severin", "thumbUrl"=>"http://www.eyeem.com/thumb/sq/50/b9c94f9b2aaa2e0445816f21593035cdc997f53e.jpg", "photoUrl"=>"http://www.eyeem.com/thumb/sq/200/b9c94f9b2aaa2e0445816f21593035cdc997f53e.jpg"}, "title"=>"", "caption"=>"EyeEm Underground at Berlin Hauptbahnhof", "latitude"=>"52.51826096", "longitude"=>"13.37492180", "totalLikes"=>27, "totalComments"=>0}, {"id"=>"869498", "thumbUrl"=>"http://www.eyeem.com/thumb/h/100/b8bba6096828245288fa0868c7affc5e9c31502c-1345833223", "photoUrl"=>"http://www.eyeem.com/thumb/640/480/b8bba6096828245288fa0868c7affc5e9c31502c-1345833223", "width"=>460, "height"=>460, "updated"=>"2012-08-24T20:34:09+0200", "webUrl"=>"http://www.eyeem.com/p/869498", "user"=>{"id"=>"59550", "nickname"=>"varek", "fullname"=>"André", "webUrl"=>"http://www.eyeem.com/u/varek", "thumbUrl"=>"https://graph.facebook.com/1449441885/picture?type=square", "photoUrl"=>"https://graph.facebook.com/1449441885/picture?type=large"}, "title"=>"", "caption"=>"EyeEm Underground at Berlin Hauptbahnhof", "latitude"=>"52.52515030", "longitude"=>"13.36928844", "totalLikes"=>10, "totalComments"=>1}, {"id"=>"869492", "thumbUrl"=>"http://www.eyeem.com/thumb/h/100/95973fe440826b0a92d5b52c2a93ff79bb4a67cc-1345832617", "photoUrl"=>"http://www.eyeem.com/thumb/640/480/95973fe440826b0a92d5b52c2a93ff79bb4a67cc-1345832617", "width"=>1296, "height"=>1296, "updated"=>"2012-08-24T20:33:01+0200", "webUrl"=>"http://www.eyeem.com/p/869492", "user"=>{"id"=>"59550", "nickname"=>"varek", "fullname"=>"André", "webUrl"=>"http://www.eyeem.com/u/varek", "thumbUrl"=>"https://graph.facebook.com/1449441885/picture?type=square", "photoUrl"=>"https://graph.facebook.com/1449441885/picture?type=large"}, "title"=>"", "caption"=>"EyeEm Underground in Berlin", "latitude"=>"", "longitude"=>"", "totalLikes"=>7, "totalComments"=>0}, {"id"=>"869476", "thumbUrl"=>"http://www.eyeem.com/thumb/h/100/052f338f160f5fef334df506c5b3d3b150de6c4e-1345832728", "photoUrl"=>"http://www.eyeem.com/thumb/640/480/052f338f160f5fef334df506c5b3d3b150de6c4e-1345832728", "width"=>969, "height"=>1296, "updated"=>"2012-08-24T20:25:30+0200", "webUrl"=>"http://www.eyeem.com/p/869476", "user"=>{"id"=>"106877", "nickname"=>"brainyartist", "fullname"=>"brainyartist", "webUrl"=>"http://www.eyeem.com/u/brainyartist", "thumbUrl"=>"https://graph.facebook.com/100002043068990/picture?type=square", "photoUrl"=>"https://graph.facebook.com/100002043068990/picture?type=large"}, "title"=>"", "caption"=>"EyeEm Underground in Berlin", "latitude"=>"", "longitude"=>"", "totalLikes"=>9, "totalComments"=>0}], 1345833600=>[{"id"=>"869504", "thumbUrl"=>"http://www.eyeem.com/thumb/h/100/c63bd3193327dc9636b18cd148079d275df6a684-1345833380", "photoUrl"=>"http://www.eyeem.com/thumb/640/480/c63bd3193327dc9636b18cd148079d275df6a684-1345833380", "width"=>1296, "height"=>972, "updated"=>"2012-08-24T20:36:22+0200", "webUrl"=>"http://www.eyeem.com/p/869504", "user"=>{"id"=>"1014", "nickname"=>"Flo", "fullname"=>"Flo Meissner", "webUrl"=>"http://www.eyeem.com/u/Flo", "thumbUrl"=>"https://graph.facebook.com/603396880/picture?type=square", "photoUrl"=>"https://graph.facebook.com/603396880/picture?type=large"}, "title"=>"", "caption"=>"Taking Photos in Berlin", "latitude"=>"52.46316528", "longitude"=>"13.37416649", "totalLikes"=>40, "totalComments"=>2}], 1345834200=>[{"id"=>"869566", "thumbUrl"=>"http://www.eyeem.com/thumb/h/100/1d5c83a13177e030f99e2bdab173a1105da299b9-1345834347", "photoUrl"=>"http://www.eyeem.com/thumb/640/480/1d5c83a13177e030f99e2bdab173a1105da299b9-1345834347", "width"=>446, "height"=>595, "updated"=>"2012-08-24T20:52:50+0200", "webUrl"=>"http://www.eyeem.com/p/869566", "user"=>{"id"=>"59550", "nickname"=>"varek", "fullname"=>"André", "webUrl"=>"http://www.eyeem.com/u/varek", "thumbUrl"=>"https://graph.facebook.com/1449441885/picture?type=square", "photoUrl"=>"https://graph.facebook.com/1449441885/picture?type=large"}, "title"=>"", "caption"=>"EyeEm Underground at Berlin Hauptbahnhof", "latitude"=>"52.52515030", "longitude"=>"13.36928844", "totalLikes"=>14, "totalComments"=>0}, {"id"=>"869561", "thumbUrl"=>"http://www.eyeem.com/thumb/h/100/d69888f0ae33843f6fa6fa602c1ec2a63e048618-1345834224", "photoUrl"=>"http://www.eyeem.com/thumb/640/480/d69888f0ae33843f6fa6fa602c1ec2a63e048618-1345834224", "width"=>396, "height"=>640, "updated"=>"2012-08-24T20:51:08+0200", "webUrl"=>"http://www.eyeem.com/p/869561", "user"=>{"id"=>"59550", "nickname"=>"varek", "fullname"=>"André", "webUrl"=>"http://www.eyeem.com/u/varek", "thumbUrl"=>"https://graph.facebook.com/1449441885/picture?type=square", "photoUrl"=>"https://graph.facebook.com/1449441885/picture?type=large"}, "title"=>"", "caption"=>"EyeEm Underground at Berlin Hauptbahnhof", "latitude"=>"52.52515030", "longitude"=>"13.36928844", "totalLikes"=>9, "totalComments"=>0}, {"id"=>"869538", "thumbUrl"=>"http://www.eyeem.com/thumb/h/100/89074a5d1c845373564195b0debddd29dec1e950-1345833758", "photoUrl"=>"http://www.eyeem.com/thumb/640/480/89074a5d1c845373564195b0debddd29dec1e950-1345833758", "width"=>1296, "height"=>972, "updated"=>"2012-08-24T20:46:33+0200", "webUrl"=>"http://www.eyeem.com/p/869538", "user"=>{"id"=>"1014", "nickname"=>"Flo", "fullname"=>"Flo Meissner", "webUrl"=>"http://www.eyeem.com/u/Flo", "thumbUrl"=>"https://graph.facebook.com/603396880/picture?type=square", "photoUrl"=>"https://graph.facebook.com/603396880/picture?type=large"}, "title"=>"", "caption"=>"EyeEm Underground in Berlin", "latitude"=>"52.46316528", "longitude"=>"13.37416649", "totalLikes"=>70, "totalComments"=>4}, {"id"=>"869569", "thumbUrl"=>"http://www.eyeem.com/thumb/h/100/22e3ca23c666d3a6bc1c1adb465ce3751131addb-1345834383", "photoUrl"=>"http://www.eyeem.com/thumb/640/480/22e3ca23c666d3a6bc1c1adb465ce3751131addb-1345834383", "width"=>1017, "height"=>1296, "updated"=>"2012-08-24T20:53:26+0200", "webUrl"=>"http://www.eyeem.com/p/869569", "user"=>{"id"=>"106877", "nickname"=>"brainyartist", "fullname"=>"brainyartist", "webUrl"=>"http://www.eyeem.com/u/brainyartist", "thumbUrl"=>"https://graph.facebook.com/100002043068990/picture?type=square", "photoUrl"=>"https://graph.facebook.com/100002043068990/picture?type=large"}, "title"=>"", "caption"=>"EyeEm Underground at Berlin Hauptbahnhof", "latitude"=>"52.52515030", "longitude"=>"13.36928844", "totalLikes"=>12, "totalComments"=>0}], 1345834800=>[{"id"=>"869595", "thumbUrl"=>"http://www.eyeem.com/thumb/h/100/e73c36de4b4824f9bc377315dde4debb05482068-1345834859", "photoUrl"=>"http://www.eyeem.com/thumb/640/480/e73c36de4b4824f9bc377315dde4debb05482068-1345834859", "width"=>582, "height"=>436, "updated"=>"2012-08-24T21:01:26+0200", "webUrl"=>"http://www.eyeem.com/p/869595", "user"=>{"id"=>"59550", "nickname"=>"varek", "fullname"=>"André", "webUrl"=>"http://www.eyeem.com/u/varek", "thumbUrl"=>"https://graph.facebook.com/1449441885/picture?type=square", "photoUrl"=>"https://graph.facebook.com/1449441885/picture?type=large"}, "title"=>"", "caption"=>"EyeEm Underground at Berlin Hauptbahnhof", "latitude"=>"52.52515030", "longitude"=>"13.36928844", "totalLikes"=>12, "totalComments"=>0}], 1345835400=>[], 1345836000=>[{"id"=>"869642", "thumbUrl"=>"http://www.eyeem.com/thumb/h/100/605bc92bf5bfdb45006761642058e55a75183234-1345835990", "photoUrl"=>"http://www.eyeem.com/thumb/640/480/605bc92bf5bfdb45006761642058e55a75183234-1345835990", "width"=>1296, "height"=>1296, "updated"=>"2012-08-24T21:20:11+0200", "webUrl"=>"http://www.eyeem.com/p/869642", "user"=>{"id"=>"106877", "nickname"=>"brainyartist", "fullname"=>"brainyartist", "webUrl"=>"http://www.eyeem.com/u/brainyartist", "thumbUrl"=>"https://graph.facebook.com/100002043068990/picture?type=square", "photoUrl"=>"https://graph.facebook.com/100002043068990/picture?type=large"}, "title"=>"", "caption"=>"EyeEm Underground in Berlin", "latitude"=>"", "longitude"=>"", "totalLikes"=>13, "totalComments"=>4}], 1345836600=>[], 1345837200=>[], 1345837800=>[], 1345838400=>[], 1345839000=>[], 1345839600=>[], 1345840200=>[], 1345840800=>[], 1345841400=>[], 1345842000=>[], 1345842600=>[], 1345843200=>[], 1345843800=>[], 1345844400=>[], 1345845000=>[], 1345845600=>[], 1345846200=>[], 1345846800=>[], 1345847400=>[], 1345848000=>[], 1345848600=>[], 1345849200=>[]}.to_json
  #lat = 52.52515030
  #lng = 13.36928844
  logger.info lat
  logger.info lng
  start_date = DateTime.parse(params[:start_date]) rescue DateTime.new(2012,8,24,20,0,0,'+2')
  end_date = start_date+5.hours #DateTime.parse(end_date) rescue start_date+5.hours #DateTime.now
  datetime_steps = start_date.step(end_date,10.minutes).to_a
  buckets = datetime_steps.inject([]) {|t,z| t << z.to_i; t << []}
  buckets = Hash[*buckets]
  points = [[lat,lng],[lat+0.0045,lng],[lat,lng-0.0045],[lat-0.0045,lng],[lat,lng+0.0045]]
  nearby_venues = []
  points.each do |point|
    nearby_venues << EyeEmConnector.albums(:geoSearch => 'nearbyVenues', :lat => point[0], :lng => point[1])['albums']['items']
  end
  nearby_venue_ids = nearby_venues.flatten.map{|w|w['id']}.uniq
  logger.info nearby_venue_ids.count
  nearby_venue_ids.each do |venue_id|
    offset = 0
    earliest_photo_date = DateTime.now
    tries = 10
    while tries > 0 && earliest_photo_date > (start_date-30.minutes) do
      ps = EyeEmConnector.album_photos(venue_id,{:limit => 50, :offset => offset, :detailed => true})['photos']['items']
      ps.each do |photo|
        photo_datetime = DateTime.parse(photo['updated'])
        buckets[start_date.to_i] << photo if photo_datetime > start_date-30.minutes && photo_datetime < start_date+30.minutes && photo['latitude'].to_f > lat-0.008 && photo['latitude'].to_f < lat+0.008 && photo['longitude'].to_f > lng-0.008 && photo['longitude'].to_f < lng+0.008
      end
      offset += 50
      tries -= 1
      earliest_photo_date = DateTime.parse(ps.last['updated']) if ps.last.present?
    end
  end
  user_ids = buckets[start_date.to_i].map {|photo| photo['user']['id']}.uniq
  logger.info user_ids
  user_ids.each do |user_id|
    offset = 0
    tries = 10
    earliest_photo_date = DateTime.now
    while tries > 0 && earliest_photo_date > (start_date-5.minutes) do
      ps = EyeEmConnector.user_photos(user_id,{:limit => 50, :offset => offset, :detailed => true})['photos']['items']
      prev_photo_location = [ps.first['latitude'].to_f,ps.first['longitude'].to_f]
      ps.each do |photo|
        photo_datetime = DateTime.parse(photo['updated'])
        datetime_step = round_datetime(photo_datetime,datetime_steps)
        if datetime_step.present?
          buckets[datetime_step.to_i] << photo  && photo['latitude'].to_f > prev_photo_location[0]-0.008 && photo['latitude'].to_f < prev_photo_location[0]+0.008 && photo['longitude'].to_f > prev_photo_location[1]-0.008 && photo['longitude'].to_f < prev_photo_location[1]+0.008
          prev_photo_location = [ps.first['latitude'].to_f,ps.first['longitude'].to_f]
        end
      end
      offset += 50
      tries -= 1
      earliest_photo_date = DateTime.parse(ps.last['updated']) if ps.last.present?
    end
  end
  #logger.info buckets
  [start_date.to_i,buckets].to_json

  #nearby_venue_ids.to_json
end

def round_datetime(photo_datetime,steps)
  steps.detect{|step| photo_datetime > step-5.minutes && photo_datetime < step+5.minutes }
end

helpers do
  def partial(page, options={})
    erb page, options.merge!(:layout => false)
  end
end


